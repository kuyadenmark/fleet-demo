<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Vehicle GPS Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 16px;
      background: #f7f7f7;
    }
    h2 {
      margin-bottom: 10px;
    }
    input {
      width: 100%;
      padding: 10px;
      font-size: 16px;
      margin-bottom: 10px;
    }
    button {
      padding: 12px;
      font-size: 16px;
      margin-right: 10px;
      margin-top: 5px;
    }
    #log {
      margin-top: 15px;
      font-size: 14px;
      white-space: pre-line;
      background: #fff;
      padding: 10px;
      border-radius: 6px;
    }
  </style>
</head>
<body>

<h2>üì° Vehicle GPS Demo</h2>

<p><b>Vehicle ID:</b></p>
<input id="vehicleId" value="9197dd05-5b2f-4c4b-b9e4-b6aff639db18">

<button onclick="startTrip()">‚ñ∂ Start Trip</button>
<button onclick="stopTrip()">‚èπ Stop Trip</button>

<div id="log">Idle‚Ä¶</div>

<script>
/* =======================
   CONFIG
======================= */
const SUPABASE_URL = "https://gfvbgzoqglqqttbrlxiu.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdmdmJnem9xZ2xxcXR0YnJseGl1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0OTY1OTUsImV4cCI6MjA4NjA3MjU5NX0.DSkCoU0bHvSI7uGssPm_OVCH5fGyJ8FjCMKqJvZwSdk";

/* =======================
   STATE
======================= */
let watchId = null;
let lastLat = null;
let lastLng = null;

/* =======================
   HELPERS
======================= */
function log(msg) {
  document.getElementById("log").innerText = msg;
}

/* =======================
   GPS PERMISSION CHECK
======================= */
async function checkPermission() {
  if (!navigator.geolocation) {
    log("‚ùå Geolocation not supported");
    return false;
  }

  return new Promise((resolve) => {
    navigator.geolocation.getCurrentPosition(
      () => resolve(true),
      (err) => {
        if (err.code === 1) {
          log("‚ùå Location permission denied");
        } else if (err.code === 2) {
          log("‚ùå GPS unavailable");
        } else {
          log("‚ùå GPS timeout");
        }
        resolve(false);
      },
      { enableHighAccuracy: true, timeout: 8000 }
    );
  });
}

/* =======================
   START TRIP
======================= */
async function startTrip() {
  const ok = await checkPermission();
  if (!ok) return;

  const vehicleId = document.getElementById("vehicleId").value;

  // Open trip (optional RPC)
  await fetch(`${SUPABASE_URL}/rest/v1/rpc/open_trip`, {
    method: "POST",
    headers: {
      apikey: SUPABASE_KEY,
      Authorization: `Bearer ${SUPABASE_KEY}`,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({ p_vehicle_id: vehicleId })
  });

  log("‚úÖ Tracking started‚Ä¶ waiting for GPS");

  watchId = navigator.geolocation.watchPosition(
    sendPosition,
    (err) => log("‚ùå GPS error: " + err.message),
    { enableHighAccuracy: true, maximumAge: 0, timeout: 10000 }
  );
}

/* =======================
   SEND GPS POSITION
======================= */
async function sendPosition(pos) {
  const vehicleId = document.getElementById("vehicleId").value;

  lastLat = pos.coords.latitude;
  lastLng = pos.coords.longitude;

  const data = {
    vehicle_id: vehicleId,
    latitude: lastLat,
    longitude: lastLng,
    ignition: true
  };

  await fetch(`${SUPABASE_URL}/rest/v1/positions`, {
    method: "POST",
    headers: {
      apikey: SUPABASE_KEY,
      Authorization: `Bearer ${SUPABASE_KEY}`,
      "Content-Type": "application/json"
    },
    body: JSON.stringify(data)
  });

  log(
`üìç GPS SENT
Lat: ${lastLat.toFixed(6)}
Lng: ${lastLng.toFixed(6)}
Accuracy: ${Math.round(pos.coords.accuracy)} m
Ignition: ON`
  );
}

/* =======================
   STOP TRIP (IGNITION OFF)
======================= */
async function stopTrip() {
  if (watchId) {
    navigator.geolocation.clearWatch(watchId);
    watchId = null;
  }

  const vehicleId = document.getElementById("vehicleId").value;

  // üî¥ SEND FINAL POSITION WITH IGNITION OFF
  if (lastLat !== null && lastLng !== null) {
    await fetch(`${SUPABASE_URL}/rest/v1/positions`, {
      method: "POST",
      headers: {
        apikey: SUPABASE_KEY,
        Authorization: `Bearer ${SUPABASE_KEY}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        vehicle_id: vehicleId,
        latitude: lastLat,
        longitude: lastLng,
        ignition: false
      })
    });
  }

  // Close trip (optional RPC)
  await fetch(`${SUPABASE_URL}/rest/v1/rpc/close_active_trip`, {
    method: "POST",
    headers: {
      apikey: SUPABASE_KEY,
      Authorization: `Bearer ${SUPABASE_KEY}`,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      p_vehicle_id: vehicleId,
      p_reason: "manual"
    })
  });

  log("‚èπ Trip stopped\nIgnition: OFF");
}
</script>

</body>
</html>
