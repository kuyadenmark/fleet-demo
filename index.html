<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>GPS Live Test</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 15px;
      background: #f5f5f5;
    }
    button {
      padding: 10px 15px;
      margin: 5px 0;
      font-size: 16px;
    }
    #log {
      margin-top: 10px;
      background: #fff;
      padding: 10px;
      height: 200px;
      overflow-y: auto;
      font-size: 14px;
    }
  </style>
</head>
<body>

  <h2>üöó GPS Live Tracking</h2>

  <button onclick="startTracking()">‚ñ∂Ô∏è Start Tracking</button><br />
  <button onclick="stopTracking()">‚õî Stop Tracking</button>

  <div id="log"></div>

  <script>
    /* ===============================
       üîê SUPABASE CONFIG
       =============================== */
    const SUPABASE_URL = "YOUR_SUPABASE_URL";
    const SUPABASE_KEY = "YOUR_SUPABASE_ANON_KEY";

    const supabase = supabase.createClient(
      SUPABASE_URL,
      SUPABASE_KEY
    );

    /* ===============================
       üì° STATE
       =============================== */
    let watchId = null;
    let ignition = false;
    let lastRowId = null;

    const logBox = document.getElementById("log");

    function log(msg) {
      const p = document.createElement("div");
      p.textContent = new Date().toLocaleTimeString() + " - " + msg;
      logBox.prepend(p);
    }

    /* ===============================
       ‚ñ∂Ô∏è START TRACKING
       =============================== */
    async function startTracking() {
      if (!navigator.geolocation) {
        alert("Geolocation not supported");
        return;
      }

      ignition = true;
      log("üü¢ Ignition ON");

      watchId = navigator.geolocation.watchPosition(
        sendPosition,
        err => log("‚ùå GPS error: " + err.message),
        {
          enableHighAccuracy: true,
          maximumAge: 1000,
          timeout: 20000
        }
      );
    }

    /* ===============================
       ‚õî STOP TRACKING
       =============================== */
    async function stopTracking() {
      ignition = false;
      log("üî¥ Ignition OFF");

      if (watchId !== null) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
      }

      if (lastRowId) {
        await supabase
          .from("gps_logs")
          .update({ ignition: false })
          .eq("id", lastRowId);
      }
    }

    /* ===============================
       üìç SEND GPS TO SUPABASE
       =============================== */
    async function sendPosition(position) {
      const lat = position.coords.latitude;
      const lng = position.coords.longitude;
      const speed = position.coords.speed || 0;
      const accuracy = position.coords.accuracy;

      log(`üìç ${lat.toFixed(5)}, ${lng.toFixed(5)} | ${accuracy}m`);

      const { data, error } = await supabase
        .from("gps_logs")
        .insert([
          {
            latitude: lat,
            longitude: lng,
            speed: speed,
            ignition: ignition,
            created_at: new Date().toISOString()
          }
        ])
        .select()
        .single();

      if (error) {
        log("‚ùå DB error");
      } else {
        lastRowId = data.id;
        log("‚úÖ Sent to Supabase");
      }
    }
  </script>

</body>
</html>
